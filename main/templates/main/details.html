{% extends 'main/base.html' %}

{% block content %}

<div class="container">
    <br>
  <div class="card">
    <div class="card-body">
    <div class="row">
        <div class="col-md-4">
            <img src="{{ novel.image }}" alt="{{ novel.name }}" class="img-fluid">
        </div>
        <div class="col-md-8">
          <h3 class="text-center">
            {{novel.name}}
          </h3>
            <p> {{ novel.description }}</p>
            <h5> Author: <span class="text-muted small">{{novel.author}}</span></h5>
            <h5> Release Date:<span class="text-muted small"> {{ novel.release_date }}</span></h5>
            <h5> Rating:<span class="text-muted small"> {{average}}/10 ({{review_count}} review{{review_count|pluralize}})</span> </h5>
            {% if novel.genres.all %}
            <div class="genres-srction mb-3">
              <h5>Genres:</h5>
              <div class="genre-badges">
                {% for genre in novel.genres.all %}
                <span class="badge bg-secondary me-1"> {{ genre.name }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            
            {% if request.user.is_authenticated %}
              {% if request.user.is_superuser %}
                <a href="{% url 'main:edit_novels' novel.id %}" class="btn btn-secondary"> Edit </a>
                <a href="{% url 'main:delete_novels' novel.id %}" class="btn btn-outline-pink" onclick="return confirm('Are you sure you want to delete the novel?')"> Delete </a>
              {% endif %}
            {% endif %}
            
            {% if user.is_authenticated %}
                {% if is_favorite %}
                    <a href="{% url 'main:toggle_favorite' novel.id %}" class="btn btn-outline-pink btn-sm">
                        ★ Remove from Favorites
                    </a>
                {% else %}
                    <a href="{% url 'main:toggle_favorite' novel.id %}" class="btn btn-outline-secondary btn-sm">
                        ☆ Add to Favorites
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>
    </div>
  </div>
  <br>
  
  {% if not existing_review %}
  <div class="card">
    <div class="card-body">
      <h3 class="text-center">Add Your Review</h3>
      
      {% if error_message %}
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
          {{ error_message }}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
          </button>
      </div>
      {% endif %}
      
      <form action="{% url 'main:add_review' novel.id %}" method="POST"> 
        {% csrf_token %}
        
        <div class="form-group">
            <label for="comment">Review</label>
            <textarea name="comment" id="comment" cols="30" rows="5" class="form-control">{% if request.POST.comment %}{{ request.POST.comment }}{% endif %}</textarea>
        </div>

        <label for="rating">Rating</label>
        <div class="star-rating">
            <input type="radio" id="star10" name="rating" value="10" {% if request.POST.rating == "10" %}checked{% endif %}>
            <label for="star10" class="rating__item" data-value="10">★</label>
            
            <input type="radio" id="star9" name="rating" value="9" {% if request.POST.rating == "9" %}checked{% endif %}>
            <label for="star9" class="rating__item" data-value="9">★</label>
            
            <input type="radio" id="star8" name="rating" value="8" {% if request.POST.rating == "8" %}checked{% endif %}>
            <label for="star8" class="rating__item" data-value="8">★</label>
            
            <input type="radio" id="star7" name="rating" value="7" {% if request.POST.rating == "7" %}checked{% endif %}>
            <label for="star7" class="rating__item" data-value="7">★</label>
            
            <input type="radio" id="star6" name="rating" value="6" {% if request.POST.rating == "6" %}checked{% endif %}>
            <label for="star6" class="rating__item" data-value="6">★</label>
            
            <input type="radio" id="star5" name="rating" value="5" {% if request.POST.rating == "5" %}checked{% endif %}>
            <label for="star5" class="rating__item" data-value="5">★</label>
            
            <input type="radio" id="star4" name="rating" value="4" {% if request.POST.rating == "4" %}checked{% endif %}>
            <label for="star4" class="rating__item" data-value="4">★</label>
            
            <input type="radio" id="star3" name="rating" value="3" {% if request.POST.rating == "3" %}checked{% endif %}>
            <label for="star3" class="rating__item" data-value="3">★</label>
            
            <input type="radio" id="star2" name="rating" value="2" {% if request.POST.rating == "2" %}checked{% endif %}>
            <label for="star2" class="rating__item" data-value="2">★</label>
            
            <input type="radio" id="star1" name="rating" value="1" {% if request.POST.rating == "1" %}checked{% endif %}>
            <label for="star1" class="rating__item" data-value="1">★</label>
        </div>

        <br>
        <input type="submit" class="custom-pink-button mt-2" value="Add Review">
      </form>
    </div>
  </div>
  {% else %}
  <div class="card">
    <div class="card-body text-center">
      <h4>You've already reviewed this novel!</h4>
      <p>You can <a href="{% url 'main:edit_review' novel.id existing_review.id %}">edit your existing review</a> instead.</p>
    </div>
  </div>
{% endif %}
  <br>

  <!-- Reviews List -->
  <div class="card">
    <div class="card-body">
      {% if reviews %}
      <ul>
         <h3 class="text-center">Reviews</h3>
         <br>
      {% for review in reviews %}
       <div class="card" style="background-color: #d3eac7;">
        <div class="card-body">
          <div class="row" >
            <div class="col-md-3 text-center">
              <div class="mb-3">
                <a href="{% url 'main:user_profile' review.user.username %}" >
                    {% if review.user.profile.profile_picture %}
                    <img src="{{ review.user.profile.profile_picture.url }}" 
                         alt="{{ review.user.username }}" 
                         class="img-fluid rounded-circle" 
                         style="width: 60px; height: 60px; object-fit: cover;">
                    {% else %}
                    <div class="bg-secondary rounded-circle d-inline-flex align-items-center justify-content-center" 
                         style="width: 60px; height: 60px;">
                        <span class="text-white">{{ review.user.username|first|upper }}</span>
                    </div>
                    {% endif %}
                    </a>
                </div>
                
                <h6 class="mb-1">
                    <a href="{% url 'main:user_profile' review.user.username %}" 
                       class="text-dark text-decoration-none">
                        {{ review.user.username }}
                    </a>
                </h6>
                
                <h5 style="color: rgb(31, 40, 31);">{{ review.rating }}/10</h5>
                
                {% if request.user == review.user %}
                <div class="mt-2">
                    <a href="{% url 'main:edit_review' novel.id review.id %}" 
                       class="btn btn-sm btn-outline-secondary">Edit</a>
                    <a href="{% url 'main:delete_review' novel.id review.id %}" 
                       class="btn btn-sm btn-outline-pink" 
                       onclick="return confirm('Delete your review?')">Delete</a>
                </div>
                {% endif %}
            </div>
          
            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-start">
                    <span class="text-muted small">
                        {{ review.created_at|date:"M d, Y" }}
                    </span>
                </div>
                <p class="mt-2">{{ review.comment }}</p>
            </div>
        </div>
    </div>
</div>
<br>
{% endfor %}
      </ul>
{% else %}
<div class="alert alert-info">
       No reviews yet.
    </div>
 {% endif %}
    </div>
  </div>
</div>
{% endblock %}